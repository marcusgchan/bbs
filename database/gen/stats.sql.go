// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.25.0
// source: stats.sql

package database

import (
	"context"
	"database/sql"
)

const getMostRecentStats = `-- name: GetMostRecentStats :many
SELECT Avg.version, Avg.avgWave, Max.maxWave, Count.numOfTestEvents
FROM (
    SELECT test_events.version, AVG(player_test_results.waveDied) as avgWave
    FROM (
        SELECT version, testResultId FROM test_events
        WHERE test_events.testResultId IS NOT NULL
        ORDER BY version DESC
        LIMIT ?
    ) as V
    JOIN test_events ON test_events.version = V.version
    JOIN player_test_results ON player_test_results.testResultId = test_events.testResultId
    WHERE test_events.testResultId IS NOT NULL
    GROUP BY test_events.version
) as Avg, (
    SELECT test_events.version, MAX(player_test_results.waveDied) as maxWave
    FROM (
        SELECT version, testResultId FROM test_events
        WHERE test_events.testResultId IS NOT NULL
        ORDER BY version DESC
        LIMIT ?
    ) as V2
    JOIN test_events ON test_events.version = V2.version
    JOIN player_test_results ON player_test_results.testResultId = test_events.testResultId
    WHERE test_events.testResultId IS NOT NULL
    GROUP BY test_events.version
) as Max, (
    SELECT test_events.version, COUNT(test_events.id) as numOfTestEvents
    FROM (
        SELECT version, testResultId FROM test_events
        WHERE test_events.testResultId IS NOT NULL
        ORDER BY version DESC
        LIMIT ?
    ) as V3
    JOIN test_events ON test_events.version = V3.version
    WHERE test_events.testResultId IS NOT NULL
    GROUP BY test_events.version
) as Count
WHERE Avg.version = Max.version AND Max.version = Count.version
`

type GetMostRecentStatsParams struct {
	Limit   int64
	Limit_2 int64
	Limit_3 int64
}

type GetMostRecentStatsRow struct {
	Version         string
	Avgwave         sql.NullFloat64
	Maxwave         interface{}
	Numoftestevents int64
}

func (q *Queries) GetMostRecentStats(ctx context.Context, arg GetMostRecentStatsParams) ([]GetMostRecentStatsRow, error) {
	rows, err := q.db.QueryContext(ctx, getMostRecentStats, arg.Limit, arg.Limit_2, arg.Limit_3)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetMostRecentStatsRow
	for rows.Next() {
		var i GetMostRecentStatsRow
		if err := rows.Scan(
			&i.Version,
			&i.Avgwave,
			&i.Maxwave,
			&i.Numoftestevents,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}
